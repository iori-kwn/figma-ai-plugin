# Figma AI プラグイン - 技術仕様書・要件定義書

## 1. プロジェクト概要

### 1.1 プロダクト概要

**プロダクト名**: Figma + Claude AI デザインプラグイン  
**目的**: Figma プラグインで日本語プロンプトから AI による UI/UX デザイン要素の自動生成  
**開発期間**: 開発中（MVP 段階）  
**対象ユーザー**: デザイナー、プロダクトマネージャー、フロントエンドエンジニア

### 1.2 主要機能

- 日本語プロンプトベースのデザイン生成
- Claude API（複数モデル対応）による高品質な UI 案作成
- Figma 内でのリアルタイムデザイン描画
- ユーザー指定 API キーによるゼロコスト運用

---

## 2. 技術スタック・アーキテクチャ

### 2.1 現在の技術構成

| 層                 | 技術                                    | 詳細                            |
| ------------------ | --------------------------------------- | ------------------------------- |
| **フロントエンド** | TypeScript, Figma Plugin API            | プラグイン UI・デザイン生成処理 |
| **バックエンド**   | Vercel Serverless Functions             | Claude API 呼び出しプロキシ     |
| **AI API**         | Anthropic Claude API (拡張可能な設計)   | UI 案生成エンジン               |
| **デプロイ**       | Vercel (Hobby Plan → Pro Plan 移行予定) | サーバーレス環境                |

### 2.2 システムアーキテクチャ図

```
[Figma Plugin (TypeScript)]
        ↓ HTTPS Request
[Vercel Proxy API (/api/proxy.js)]
        ↓ HTTPS Request
[Claude API (api.anthropic.com)]
        ↓ JSON Response
[Figma Canvas (Design Rendering)]
```

### 2.3 データフロー詳細

1. **ユーザー入力**: 日本語プロンプト（例：「EC サイトの商品一覧画面を作成して」）
2. **プラグイン処理**: プロンプトを構造化して API リクエスト作成
3. **プロキシ経由**: Vercel Function が Claude API を呼び出し（CORS 対応）
4. **AI 処理**: Claude が UI 設計 JSON（15-45 秒）を生成
5. **レンダリング**: Figma で Frame、Rectangle、Text 要素を動的生成

---

## 3. 課題分析・インフラ要件

### 3.1 現在の技術的課題

#### 【課題 1】タイムアウト問題（最優先）

- **現状**: Vercel Hobby Plan の 10 秒制限
- **AI 処理時間**: Claude API レスポンス 15-45 秒
- **発生頻度**: 約 60-70%のリクエストで途中切断
- **影響**: JSON 不完全・デザイン生成失敗

#### 【課題 2】CORS 制約

- **現状**: Figma Plugin では外部 API 直接呼び出し不可
- **解決策**: プロキシサーバー必須
- **要件**: HTTPS 対応・レスポンシブ設計

#### 【課題 3】コスト管理

- **現状**: ユーザー指定 API キー（開発コスト無し）
- **将来**: 大量利用時の API 課金体系検討

### 3.2 インフラ要件定義

#### 【必須要件】

- **実行時間**: 60 秒以上（AI 処理対応）
- **メモリ**: 1GB 以上（JSON 処理）
- **可用性**: 99.9%（プロダクション対応）
- **セキュリティ**: HTTPS・API キー暗号化

#### 【望ましい要件】

- **スケーラビリティ**: 同時リクエスト 100+
- **モニタリング**: ログ・メトリクス・アラート
- **地理的分散**: 日本・米国リージョン対応

---

## 4. インフラ移行計画・選択肢

### 4.1 短期解決策（1-2 週間）

#### **選択肢 A: Vercel Pro Plan** [推奨]

```yaml
プラン: Vercel Pro ($20/月)
実行時間: 10秒 → 60秒 (6倍改善)
メモリ: 1024MB
想定成功率: 95%+
移行工数: 1-2日
```

**メリット**:

- 設定変更のみで即座に解決
- 既存コードベース変更不要
- サポート・SLA 付き

**デメリット**:

- 月額コスト $20
- ベンダーロックイン

#### **選択肢 B: Netlify Functions**

```yaml
プラン: Netlify Pro ($19/月)
実行時間: 26秒 (Vercelより劣る)
メモリ: 1024MB
想定成功率: 70-80%
移行工数: 3-5日
```

### 4.2 中長期解決策（1-3 ヶ月）

#### **選択肢 C: AWS Lambda + API Gateway** [長期推奨]

```yaml
実行時間: 15分 (大幅余裕)
メモリ: 最大10GB
コスト: 従量課金 (月1000回: ~$5)
可用性: 99.95%
移行工数: 2-3週間
```

**必要な AWS リソース**:

- Lambda Function (Node.js 18.x)
- API Gateway (REST API)
- CloudWatch Logs
- IAM Role/Policy

**必要な IAM 権限**:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "lambda:InvokeFunction",
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents",
        "apigateway:*"
      ],
      "Resource": "*"
    }
  ]
}
```

---

## 5. セキュリティ・運用要件

### 5.1 セキュリティ要件

#### **API キー管理**

- **現状**: ユーザーローカルストレージ保存
- **リスク**: クライアントサイド保存
- **改善案**: AWS Secrets Manager / Vercel Environment Variables

#### **通信セキュリティ**

- HTTPS 必須（既に対応済み）
- CORS 適切設定（既に対応済み）
- Rate Limiting（未実装 → 要追加）

#### **監査・ログ**

- API 呼び出しログ（部分実装済み）
- エラー追跡（Vercel Analytics）
- セキュリティ監査（要検討）

### 5.2 運用・監視要件

#### **モニタリング指標**

- レスポンス時間（目標: 平均 30 秒以下）
- 成功率（目標: 95%以上）
- エラー種別（Timeout, API Error, Network Error）
- 利用量（DAU、リクエスト数）

#### **アラート設定**

- 成功率 85%以下
- 平均レスポンス時間 60 秒以上
- API エラー率 10%以上

---

## 6. 実装詳細・技術仕様

### 6.1 API 仕様

#### **プロキシエンドポイント**

```
POST /api/proxy
Content-Type: application/json
x-api-key: {ユーザーAPIキー}

Request:
{
  "model": "claude-3-5-sonnet-20241022",
  "max_tokens": 1000,
  "messages": [
    {
      "role": "user",
      "content": "{構造化プロンプト}"
    }
  ]
}

Response:
{
  "content": [
    {
      "text": "{UIデザインJSON}"
    }
  ],
  "_meta": {
    "requestDuration": 25000,
    "timestamp": "2024-01-15T10:30:00.000Z"
  }
}
```

#### **対応 Claude モデル**

**現在対応済み**:

- claude-opus-4-20250514 (Claude Opus 4 - 最新・最高性能)
- claude-sonnet-4-20250514 (Claude Sonnet 4 - 高性能)
- claude-3-7-sonnet-20250219 (Claude 3.7 Sonnet)
- claude-3-5-sonnet-20241022 (Claude 3.5 Sonnet - 推奨: 高品質)
- claude-3-5-haiku-20241022 (Claude 3.5 Haiku - 高速: 10-20 秒)
- claude-3-opus-20240229 (Claude 3 Opus - 最高品質: 30-60 秒)
- claude-3-sonnet-20240229 (Claude 3 Sonnet)

**アーキテクチャ注記**:

- UI は複数 AI サービス対応の設計（将来的な OpenAI GPT、Google Gemini 等の追加可能）
- 現在のバックエンドは Claude API のみ実装
- 他の AI サービス追加時は プロキシ API の拡張が必要

### 6.2 パフォーマンス最適化

#### **既実装最適化**

- max_tokens 上限: 1500 (レスポンス時間短縮)
- AbortController: 50 秒タイムアウト
- Client-side timeout: 55 秒バックアップ
- 詳細ログ・メトリクス

#### **追加検討項目**

- Claude Streaming API（段階的レスポンス）
- Redis Cache（同一プロンプト結果キャッシュ）
- CDN 配信（静的アセット）

---

## 7. 移行スケジュール・作業計画

### 7.1 Phase 1: 緊急対応（1-2 週間）

#### **Week 1**

- [ ] Vercel Pro Plan アップグレード
- [ ] タイムアウト設定更新・テスト
- [ ] 成功率モニタリング開始

#### **Week 2**

- [ ] パフォーマンス最適化コード投入
- [ ] エラーハンドリング強化
- [ ] ユーザビリティ向上

### 7.2 Phase 2: AWS 移行準備（1 ヶ月）

#### **社内調整・権限準備**

- [ ] AWS アカウント確認・IAM 権限申請
- [ ] 開発環境 AWS Lambda 設定
- [ ] API Gateway + Lambda 構築

#### **開発・テスト**

- [ ] プロキシコード AWS 移植
- [ ] 負荷テスト・パフォーマンス検証
- [ ] 段階的移行（Canary Deployment）

### 7.3 Phase 3: 本格運用（2-3 ヶ月）

#### **監視・運用体制**

- [ ] CloudWatch 監視・アラート設定
- [ ] 定期メンテナンス計画
- [ ] コスト最適化・スケーリング調整

---

## 8. コスト試算

### 8.1 短期コスト (Vercel Pro)

| 項目       | 月額コスト   | 年額コスト   |
| ---------- | ------------ | ------------ |
| Vercel Pro | $20          | $240         |
| Claude API | ユーザー負担 | ユーザー負担 |
| **合計**   | **$20**      | **$240**     |

### 8.2 長期コスト (AWS Lambda)

#### **想定利用量**: 月 1,000 リクエスト

| AWS 項目        | 月額コスト |
| --------------- | ---------- |
| Lambda 実行時間 | ~$3        |
| API Gateway     | ~$1        |
| CloudWatch Logs | ~$1        |
| **合計**        | **~$5**    |

#### **想定利用量**: 月 10,000 リクエスト

| AWS 項目        | 月額コスト |
| --------------- | ---------- |
| Lambda 実行時間 | ~$25       |
| API Gateway     | ~$8        |
| CloudWatch Logs | ~$5        |
| **合計**        | **~$38**   |

---

## 9. リスク・課題・対策

### 9.1 技術リスク

| リスク                 | 影響度 | 発生確率 | 対策                               |
| ---------------------- | ------ | -------- | ---------------------------------- |
| Claude API 制限・障害  | 高     | 低       | 複数モデル対応・フォールバック実装 |
| AWS 移行時の互換性問題 | 中     | 中       | 段階的移行・ロールバック計画       |
| 大量利用時のコスト増   | 中     | 高       | 利用量監視・アラート               |

### 9.2 運用リスク

| リスク                     | 影響度 | 発生確率 | 対策                         |
| -------------------------- | ------ | -------- | ---------------------------- |
| 社内 AWS 権限承認遅延      | 中     | 中       | Vercel Pro 並行運用          |
| API キー管理・セキュリティ | 高     | 低       | セキュリティ監査・暗号化強化 |
| 利用者増加時の負荷対応     | 中     | 高       | 自動スケーリング・監視強化   |

---

## 10. 次期提出・承認事項

### 10.1 社内承認が必要な項目

1. **AWS アカウント・IAM 権限**

   - Lambda Function 実行権限
   - API Gateway 管理権限
   - CloudWatch Logs 書き込み権限
   - Cost Budget 設定権限

2. **予算承認**

   - 短期: Vercel Pro $20/月
   - 長期: AWS 利用料 $5-50/月（利用量次第）

3. **セキュリティ・コンプライアンス確認**
   - 外部 API 利用承認（Claude API）
   - 個人情報・機密情報の取り扱い確認
   - 利用ログ・監査要件の確認

### 10.2 追加検討・情報収集事項

1. **ビジネス要件**

   - 想定利用者数・利用頻度
   - SLA・サービス品質要件
   - 将来の機能拡張計画

2. **技術要件**

   - 社内ネットワーク・セキュリティポリシー
   - 既存インフラとの連携要件
   - バックアップ・災害復旧要件

3. **運用要件**
   - 24/7 監視の必要性
   - インシデント対応フロー
   - 定期メンテナンス計画

---

## 11. 結論・推奨アクション

### 11.1 immediate Action（今すぐ）

1. **Vercel Pro アップグレード** - タイムアウト問題の即座解決
2. **パフォーマンス監視開始** - 成功率・レスポンス時間の可視化

### 11.2 Short-term（1 ヶ月以内）

1. **AWS 権限申請・承認** - 社内プロセス開始
2. **開発環境での AWS Lambda 構築** - 移行準備

### 11.3 Long-term（3 ヶ月以内）

1. **AWS 本格移行** - コスト最適化・スケーラビリティ確保
2. **監視・運用体制確立** - 安定運用の基盤構築

---

**このドキュメントに関する質問・追加情報が必要な場合は、開発チームまでお声がけください。**

---

_最終更新: 2024 年 12 月_
_作成者: Development Team_
_承認者: [要記入]_
